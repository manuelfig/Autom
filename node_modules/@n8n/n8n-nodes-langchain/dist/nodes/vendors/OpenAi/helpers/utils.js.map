{"version":3,"sources":["../../../../../nodes/vendors/OpenAi/helpers/utils.ts"],"sourcesContent":["import type { BaseMessage } from '@langchain/core/messages';\nimport type { Tool } from '@langchain/core/tools';\nimport type { OpenAIClient } from '@langchain/openai';\nimport type { BufferWindowMemory } from 'langchain/memory';\nimport { isObjectEmpty } from 'n8n-workflow';\nimport { zodToJsonSchema } from 'zod-to-json-schema';\n\n// Copied from langchain(`langchain/src/tools/convert_to_openai.ts`)\n// since these functions are not exported\n\n/**\n * Formats a `Tool` instance into a format that is compatible\n * with OpenAI's ChatCompletionFunctions. It uses the `zodToJsonSchema`\n * function to convert the schema of the tool into a JSON\n * schema, which is then used as the parameters for the OpenAI function.\n */\nexport function formatToOpenAIFunction(\n\ttool: Tool,\n): OpenAIClient.Chat.ChatCompletionCreateParams.Function {\n\treturn {\n\t\tname: tool.name,\n\t\tdescription: tool.description,\n\t\tparameters: zodToJsonSchema(tool.schema),\n\t};\n}\n\nexport function formatToOpenAITool(tool: Tool): OpenAIClient.Chat.ChatCompletionTool {\n\tconst schema = zodToJsonSchema(tool.schema);\n\treturn {\n\t\ttype: 'function',\n\t\tfunction: {\n\t\t\tname: tool.name,\n\t\t\tdescription: tool.description,\n\t\t\tparameters: schema,\n\t\t},\n\t};\n}\n\nexport function formatToOpenAIAssistantTool(tool: Tool): OpenAIClient.Beta.AssistantTool {\n\treturn {\n\t\ttype: 'function',\n\t\tfunction: {\n\t\t\tname: tool.name,\n\t\t\tdescription: tool.description,\n\t\t\tparameters: zodToJsonSchema(tool.schema),\n\t\t},\n\t};\n}\n\nconst requireStrict = (schema: any) => {\n\tif (!schema.required) {\n\t\treturn false;\n\t}\n\t// when strict:true, Responses API requires `required` to be present and all properties to be included\n\tif (schema.properties) {\n\t\tconst propertyNames = Object.keys(schema.properties);\n\t\tconst somePropertyMissingFromRequired = propertyNames.some(\n\t\t\t(propertyName) => !schema.required.includes(propertyName),\n\t\t);\n\t\tconst requireStrict = !somePropertyMissingFromRequired;\n\t\treturn requireStrict;\n\t}\n\treturn false;\n};\n\nexport function formatToOpenAIResponsesTool(tool: Tool): OpenAIClient.Responses.FunctionTool {\n\tconst schema = zodToJsonSchema(tool.schema) as any;\n\tconst strict = requireStrict(schema);\n\n\t// when strict:true, Responses API requires `additionalProperties` either to be true/false or an object with properties\n\tconst isAdditionalPropertiesEmpty =\n\t\tschema.additionalProperties &&\n\t\ttypeof schema.additionalProperties === 'object' &&\n\t\tisObjectEmpty(schema.additionalProperties);\n\tif (isAdditionalPropertiesEmpty && strict) {\n\t\tschema.additionalProperties = false;\n\t}\n\n\treturn {\n\t\ttype: 'function',\n\t\tname: tool.name,\n\t\tparameters: schema,\n\t\tstrict,\n\t\tdescription: tool.description,\n\t};\n}\n\nexport async function getChatMessages(memory: BufferWindowMemory): Promise<BaseMessage[]> {\n\treturn (await memory.loadMemoryVariables({}))[memory.memoryKey] as BaseMessage[];\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA,0BAA8B;AAC9B,gCAAgC;AAWzB,SAAS,uBACf,MACwD;AACxD,SAAO;AAAA,IACN,MAAM,KAAK;AAAA,IACX,aAAa,KAAK;AAAA,IAClB,gBAAY,2CAAgB,KAAK,MAAM;AAAA,EACxC;AACD;AAEO,SAAS,mBAAmB,MAAkD;AACpF,QAAM,aAAS,2CAAgB,KAAK,MAAM;AAC1C,SAAO;AAAA,IACN,MAAM;AAAA,IACN,UAAU;AAAA,MACT,MAAM,KAAK;AAAA,MACX,aAAa,KAAK;AAAA,MAClB,YAAY;AAAA,IACb;AAAA,EACD;AACD;AAEO,SAAS,4BAA4B,MAA6C;AACxF,SAAO;AAAA,IACN,MAAM;AAAA,IACN,UAAU;AAAA,MACT,MAAM,KAAK;AAAA,MACX,aAAa,KAAK;AAAA,MAClB,gBAAY,2CAAgB,KAAK,MAAM;AAAA,IACxC;AAAA,EACD;AACD;AAEA,MAAM,gBAAgB,CAAC,WAAgB;AACtC,MAAI,CAAC,OAAO,UAAU;AACrB,WAAO;AAAA,EACR;AAEA,MAAI,OAAO,YAAY;AACtB,UAAM,gBAAgB,OAAO,KAAK,OAAO,UAAU;AACnD,UAAM,kCAAkC,cAAc;AAAA,MACrD,CAAC,iBAAiB,CAAC,OAAO,SAAS,SAAS,YAAY;AAAA,IACzD;AACA,UAAMA,iBAAgB,CAAC;AACvB,WAAOA;AAAA,EACR;AACA,SAAO;AACR;AAEO,SAAS,4BAA4B,MAAiD;AAC5F,QAAM,aAAS,2CAAgB,KAAK,MAAM;AAC1C,QAAM,SAAS,cAAc,MAAM;AAGnC,QAAM,8BACL,OAAO,wBACP,OAAO,OAAO,yBAAyB,gBACvC,mCAAc,OAAO,oBAAoB;AAC1C,MAAI,+BAA+B,QAAQ;AAC1C,WAAO,uBAAuB;AAAA,EAC/B;AAEA,SAAO;AAAA,IACN,MAAM;AAAA,IACN,MAAM,KAAK;AAAA,IACX,YAAY;AAAA,IACZ;AAAA,IACA,aAAa,KAAK;AAAA,EACnB;AACD;AAEA,eAAsB,gBAAgB,QAAoD;AACzF,UAAQ,MAAM,OAAO,oBAAoB,CAAC,CAAC,GAAG,OAAO,SAAS;AAC/D;","names":["requireStrict"]}