{"version":3,"sources":["../../../../../../../nodes/vendors/OpenAi/v2/actions/video/generate.operation.ts"],"sourcesContent":["import FormData from 'form-data';\nimport type { IExecuteFunctions, INodeExecutionData, INodeProperties } from 'n8n-workflow';\nimport { NodeOperationError, updateDisplayOptions } from 'n8n-workflow';\n\nimport { getBinaryDataFile } from '../../../helpers/binary-data';\nimport type { VideoJob } from '../../../helpers/interfaces';\nimport { pollUntilAvailable } from '../../../helpers/polling';\nimport { apiRequest } from '../../../transport';\nimport { modelRLC } from '../descriptions';\n\nconst properties: INodeProperties[] = [\n\tmodelRLC('videoModelSearch'),\n\t{\n\t\tdisplayName: 'Prompt',\n\t\tname: 'prompt',\n\t\ttype: 'string',\n\t\tdefault: 'A video of a cat playing with a ball',\n\t\tdescription: 'The prompt to generate a video from',\n\t\trequired: true,\n\t\ttypeOptions: {\n\t\t\trows: 2,\n\t\t},\n\t},\n\t{\n\t\tdisplayName: 'Seconds',\n\t\tname: 'seconds',\n\t\ttype: 'number',\n\t\tdefault: 4,\n\t\tdescription: 'Clip duration in seconds',\n\t\trequired: true,\n\t},\n\t{\n\t\tdisplayName: 'Size',\n\t\tname: 'size',\n\t\ttype: 'options',\n\t\tdefault: '1280x720',\n\t\tdescription:\n\t\t\t'Output resolution formatted as width x height. 1024x1792 and 1792x1024 are only supported by Sora 2 Pro.',\n\t\toptions: [\n\t\t\t{ name: '720x1280', value: '720x1280' },\n\t\t\t{ name: '1280x720', value: '1280x720' },\n\t\t\t{ name: '1024x1792', value: '1024x1792' },\n\t\t\t{ name: '1792x1024', value: '1792x1024' },\n\t\t],\n\t},\n\t{\n\t\tdisplayName: 'Options',\n\t\tname: 'options',\n\t\tplaceholder: 'Add Option',\n\t\ttype: 'collection',\n\t\tdefault: {},\n\t\toptions: [\n\t\t\t{\n\t\t\t\tdisplayName: 'Reference',\n\t\t\t\tdescription: 'Optional image reference that guides generation',\n\t\t\t\tname: 'binaryPropertyNameReference',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: 'data',\n\t\t\t\tplaceholder: 'e.g. data',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Wait Timeout',\n\t\t\t\tname: 'waitTime',\n\t\t\t\ttype: 'number',\n\t\t\t\tdefault: 300,\n\t\t\t\tdescription: 'Time to wait for the video to be generated in seconds',\n\t\t\t\ttypeOptions: {\n\t\t\t\t\tminValue: 5,\n\t\t\t\t\tmaxValue: 7200,\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Output Field Name',\n\t\t\t\tname: 'fileName',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: 'data',\n\t\t\t\thint: 'The name of the output field to put the binary file data in',\n\t\t\t},\n\t\t],\n\t},\n];\n\nconst displayOptions = {\n\tshow: {\n\t\toperation: ['generate'],\n\t\tresource: ['video'],\n\t},\n};\n\nexport const description = updateDisplayOptions(displayOptions, properties);\n\nexport async function execute(this: IExecuteFunctions, i: number): Promise<INodeExecutionData[]> {\n\tconst model = this.getNodeParameter('modelId', i, '', { extractValue: true }) as string;\n\tconst prompt = this.getNodeParameter('prompt', i) as string;\n\tconst seconds = this.getNodeParameter('seconds', i) as number;\n\tconst size = this.getNodeParameter('size', i) as string;\n\tconst options = this.getNodeParameter('options', i, {});\n\tconst waitSeconds = (options.waitTime as number) || 300;\n\n\tconst formData = new FormData();\n\n\tformData.append('model', model);\n\tformData.append('prompt', prompt);\n\tformData.append('seconds', seconds.toString());\n\tformData.append('size', size);\n\n\tif (options.binaryPropertyNameReference) {\n\t\tconst { fileContent, contentType, filename } = await getBinaryDataFile(\n\t\t\tthis,\n\t\t\ti,\n\t\t\toptions.binaryPropertyNameReference as string,\n\t\t);\n\t\tconst buffer = await this.helpers.binaryToBuffer(fileContent);\n\t\tformData.append('input_reference', buffer, {\n\t\t\tfilename,\n\t\t\tcontentType,\n\t\t});\n\t}\n\n\tconst response = (await apiRequest.call(this, 'POST', '/videos', {\n\t\toption: { formData },\n\t\theaders: formData.getHeaders(),\n\t})) as VideoJob;\n\n\tconst finalResponse = await pollUntilAvailable(\n\t\tthis,\n\t\tasync () => {\n\t\t\treturn (await apiRequest.call(this, 'GET', `/videos/${response.id}`)) as VideoJob;\n\t\t},\n\t\t(response) => {\n\t\t\tif (response.error) {\n\t\t\t\tthrow new NodeOperationError(this.getNode(), 'Error generating video', {\n\t\t\t\t\tdescription: response.error.message,\n\t\t\t\t\titemIndex: i,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn response.status === 'completed';\n\t\t},\n\t\twaitSeconds,\n\t\t10,\n\t);\n\n\tconst contentResponse = await apiRequest.call(\n\t\tthis,\n\t\t'GET',\n\t\t`/videos/${finalResponse.id}/content`,\n\t\t{\n\t\t\toption: {\n\t\t\t\tuseStream: true,\n\t\t\t\tresolveWithFullResponse: true,\n\t\t\t\tjson: false,\n\t\t\t\tencoding: null,\n\t\t\t},\n\t\t},\n\t);\n\n\tconst mimeType = contentResponse.headers['content-type'];\n\n\tconst binaryData = await this.helpers.prepareBinaryData(\n\t\tcontentResponse.body,\n\t\t(options.fileName as string) || 'data',\n\t\tmimeType,\n\t);\n\n\treturn [\n\t\t{\n\t\t\tjson: Object.assign({}, binaryData, {\n\t\t\t\tdata: undefined,\n\t\t\t}),\n\t\t\tbinary: {\n\t\t\t\tdata: binaryData,\n\t\t\t},\n\t\t\tpairedItem: { item: i },\n\t\t},\n\t];\n}\n"],"mappings":"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","names":["FormData","response"]}