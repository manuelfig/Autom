{"version":3,"sources":["../../../../nodes/llms/LMChatOpenAi/common.ts"],"sourcesContent":["import type { OpenAIClient } from '@langchain/openai';\nimport type { ChatOpenAIToolType } from '@langchain/openai/dist/utils/tools';\nimport get from 'lodash/get';\nimport isObject from 'lodash/isObject';\nimport { isObjectEmpty, jsonParse } from 'n8n-workflow';\n\nimport type {\n\tBuiltInTools,\n\tChatResponseRequest,\n\tModelOptions,\n\tPromptOptions,\n\tTextOptions,\n} from './types';\n\nconst removeEmptyProperties = <T>(rest: { [key: string]: any }): T => {\n\treturn Object.keys(rest)\n\t\t.filter(\n\t\t\t(k) =>\n\t\t\t\trest[k] !== '' && rest[k] !== undefined && !(isObject(rest[k]) && isObjectEmpty(rest[k])),\n\t\t)\n\t\t.reduce((a, k) => ({ ...a, [k]: rest[k] }), {}) as unknown as T;\n};\n\nconst toArray = (str: string) =>\n\tstr\n\t\t.split(',')\n\t\t.map((e) => e.trim())\n\t\t.filter(Boolean);\n\nexport const formatBuiltInTools = (builtInTools: BuiltInTools) => {\n\tconst tools: ChatOpenAIToolType[] = [];\n\tif (builtInTools) {\n\t\tconst webSearchOptions = get(builtInTools, 'webSearch');\n\t\tif (webSearchOptions) {\n\t\t\tlet allowedDomains: string[] | undefined;\n\t\t\tconst allowedDomainsRaw = get(webSearchOptions, 'allowedDomains', '');\n\t\t\tif (allowedDomainsRaw) {\n\t\t\t\tallowedDomains = toArray(allowedDomainsRaw);\n\t\t\t}\n\n\t\t\tlet userLocation: OpenAIClient.Responses.WebSearchTool.UserLocation | undefined;\n\t\t\tif (webSearchOptions.country || webSearchOptions.city || webSearchOptions.region) {\n\t\t\t\tuserLocation = {\n\t\t\t\t\ttype: 'approximate',\n\t\t\t\t\tcountry: webSearchOptions.country as string,\n\t\t\t\t\tcity: webSearchOptions.city as string,\n\t\t\t\t\tregion: webSearchOptions.region as string,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\ttools.push({\n\t\t\t\ttype: 'web_search',\n\t\t\t\tsearch_context_size: get(webSearchOptions, 'searchContextSize', 'medium'),\n\t\t\t\tuser_location: userLocation,\n\t\t\t\t...(allowedDomains && { filters: { allowed_domains: allowedDomains } }),\n\t\t\t});\n\t\t}\n\n\t\tif (builtInTools.codeInterpreter) {\n\t\t\ttools.push({\n\t\t\t\ttype: 'code_interpreter',\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'auto',\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tif (builtInTools.fileSearch) {\n\t\t\tconst vectorStoreIds = get(builtInTools.fileSearch, 'vectorStoreIds', '[]');\n\t\t\tconst filters = get(builtInTools.fileSearch, 'filters', '{}');\n\t\t\ttools.push({\n\t\t\t\ttype: 'file_search',\n\t\t\t\tvector_store_ids: jsonParse(vectorStoreIds, {\n\t\t\t\t\terrorMessage: 'Failed to parse vector store IDs',\n\t\t\t\t}),\n\t\t\t\tfilters: filters\n\t\t\t\t\t? jsonParse(filters, { errorMessage: 'Failed to parse filters' })\n\t\t\t\t\t: undefined,\n\t\t\t\tmax_num_results: get(builtInTools.fileSearch, 'maxResults') as number,\n\t\t\t});\n\t\t}\n\t}\n\treturn tools;\n};\n\nexport const prepareAdditionalResponsesParams = (options: ModelOptions) => {\n\tconst body: Partial<ChatResponseRequest> = {\n\t\tprompt_cache_key: options.promptCacheKey,\n\t\tsafety_identifier: options.safetyIdentifier,\n\t\tservice_tier: options.serviceTier,\n\t\ttop_logprobs: options.topLogprobs,\n\t};\n\n\tif (options.conversationId) {\n\t\tbody.conversation = options.conversationId;\n\t}\n\n\tif (options.metadata) {\n\t\tbody.metadata = jsonParse(options.metadata, {\n\t\t\terrorMessage: 'Failed to parse metadata',\n\t\t});\n\t}\n\n\tif (options.promptConfig) {\n\t\tconst prompt = get(options, 'promptConfig.promptOptions', {} as PromptOptions);\n\t\tbody.prompt = removeEmptyProperties({\n\t\t\tid: prompt.promptId,\n\t\t\tversion: prompt.version,\n\t\t\t...(prompt.variables && {\n\t\t\t\tvariables: jsonParse(prompt.variables, {\n\t\t\t\t\terrorMessage: 'Failed to parse prompt variables',\n\t\t\t\t}),\n\t\t\t}),\n\t\t});\n\t}\n\n\tif (options.textFormat) {\n\t\tconst textOptions = get(options, 'textFormat.textOptions', {} as TextOptions);\n\t\tconst textConfig: OpenAIClient.Responses.ResponseTextConfig = {\n\t\t\tverbosity: textOptions.verbosity as OpenAIClient.Responses.ResponseTextConfig['verbosity'],\n\t\t};\n\t\tif (textOptions.type === 'json_schema') {\n\t\t\ttextConfig.format = {\n\t\t\t\ttype: textOptions.type,\n\t\t\t\tname: textOptions.name as string,\n\t\t\t\tschema: jsonParse(textOptions.schema as string, {\n\t\t\t\t\terrorMessage: 'Failed to parse schema',\n\t\t\t\t}),\n\t\t\t};\n\t\t} else {\n\t\t\ttextConfig.format = {\n\t\t\t\ttype: textOptions.type as 'json_object' | 'text',\n\t\t\t};\n\t\t}\n\n\t\tif (textConfig.format) {\n\t\t\ttextConfig.format = removeEmptyProperties(textConfig.format);\n\t\t}\n\n\t\tbody.text = textConfig;\n\t}\n\n\tif (options.reasoningEffort) {\n\t\tbody.reasoning = {\n\t\t\teffort: options.reasoningEffort,\n\t\t};\n\t}\n\n\treturn body;\n};\n"],"mappings":"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","names":["isObject","get"]}