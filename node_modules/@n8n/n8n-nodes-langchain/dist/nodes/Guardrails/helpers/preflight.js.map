{"version":3,"sources":["../../../../nodes/Guardrails/helpers/preflight.ts"],"sourcesContent":["import type { GuardrailResult } from '../actions/types';\n\nexport function applyPreflightModifications(\n\tdata: string,\n\tpreflightResults: GuardrailResult[],\n): string {\n\tif (preflightResults.length === 0) {\n\t\treturn data;\n\t}\n\n\t// Get PII mappings from preflight results for individual text processing\n\tconst piiMappings: Record<string, string> = {};\n\tfor (const result of preflightResults) {\n\t\tif (result.info?.maskEntities) {\n\t\t\tconst detected = result.info.maskEntities;\n\t\t\tfor (const [entityType, entities] of Object.entries(detected)) {\n\t\t\t\tfor (const entity of entities) {\n\t\t\t\t\t// Map original PII to masked token\n\t\t\t\t\tpiiMappings[entity] = `<${entityType}>`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (Object.keys(piiMappings).length === 0) {\n\t\treturn data;\n\t}\n\n\tconst maskText = (text: string): string => {\n\t\tif (typeof text !== 'string') {\n\t\t\treturn text;\n\t\t}\n\n\t\tlet maskedText = text;\n\n\t\t// Sort PII entities by length (longest first) to avoid partial replacements\n\t\t// This ensures longer matches are processed before shorter ones\n\t\tconst sortedPii = Object.entries(piiMappings).sort((a, b) => b[0].length - a[0].length);\n\n\t\tfor (const [originalPii, maskedToken] of sortedPii) {\n\t\t\tif (maskedText.includes(originalPii)) {\n\t\t\t\t// Use split/join instead of regex to avoid regex injection\n\t\t\t\t// This treats all characters literally and is safe from special characters\n\t\t\t\tmaskedText = maskedText.split(originalPii).join(maskedToken);\n\t\t\t}\n\t\t}\n\n\t\treturn maskedText;\n\t};\n\treturn maskText(data);\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEO,SAAS,4BACf,MACA,kBACS;AACT,MAAI,iBAAiB,WAAW,GAAG;AAClC,WAAO;AAAA,EACR;AAGA,QAAM,cAAsC,CAAC;AAC7C,aAAW,UAAU,kBAAkB;AACtC,QAAI,OAAO,MAAM,cAAc;AAC9B,YAAM,WAAW,OAAO,KAAK;AAC7B,iBAAW,CAAC,YAAY,QAAQ,KAAK,OAAO,QAAQ,QAAQ,GAAG;AAC9D,mBAAW,UAAU,UAAU;AAE9B,sBAAY,MAAM,IAAI,IAAI,UAAU;AAAA,QACrC;AAAA,MACD;AAAA,IACD;AAAA,EACD;AAEA,MAAI,OAAO,KAAK,WAAW,EAAE,WAAW,GAAG;AAC1C,WAAO;AAAA,EACR;AAEA,QAAM,WAAW,CAAC,SAAyB;AAC1C,QAAI,OAAO,SAAS,UAAU;AAC7B,aAAO;AAAA,IACR;AAEA,QAAI,aAAa;AAIjB,UAAM,YAAY,OAAO,QAAQ,WAAW,EAAE,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM;AAEtF,eAAW,CAAC,aAAa,WAAW,KAAK,WAAW;AACnD,UAAI,WAAW,SAAS,WAAW,GAAG;AAGrC,qBAAa,WAAW,MAAM,WAAW,EAAE,KAAK,WAAW;AAAA,MAC5D;AAAA,IACD;AAEA,WAAO;AAAA,EACR;AACA,SAAO,SAAS,IAAI;AACrB;","names":[]}