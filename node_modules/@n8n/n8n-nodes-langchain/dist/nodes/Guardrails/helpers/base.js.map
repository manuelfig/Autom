{"version":3,"sources":["../../../../nodes/Guardrails/helpers/base.ts"],"sourcesContent":["import {\n\ttype GuardrailResult,\n\tGuardrailError,\n\ttype GroupedGuardrailResults,\n\ttype StageGuardRails,\n} from '../actions/types';\n\ntype RunStageGuardrailsOptions = {\n\tstageGuardrails: StageGuardRails;\n\tstage: keyof StageGuardRails;\n\tinputText: string;\n\tfailOnlyOnErrors?: boolean;\n};\n\n// eslint-disable-next-line @typescript-eslint/promise-function-async\nconst wrapInGuardrailError = (guardrailName: string, promise: Promise<GuardrailResult>) => {\n\treturn promise.catch((error) => {\n\t\tthrow new GuardrailError(\n\t\t\tguardrailName,\n\t\t\terror?.description || error?.message || 'Unknown error',\n\t\t\terror?.description,\n\t\t);\n\t});\n};\n\nexport async function runStageGuardrails({\n\tstageGuardrails,\n\tstage,\n\tinputText,\n\tfailOnlyOnErrors,\n}: RunStageGuardrailsOptions): Promise<GroupedGuardrailResults> {\n\tconst guardrailPromises: Array<Promise<GuardrailResult>> = [];\n\tfor (const guardrail of stageGuardrails[stage]) {\n\t\tguardrailPromises.push(\n\t\t\twrapInGuardrailError(\n\t\t\t\tguardrail.name,\n\t\t\t\t// ensure the check is async\n\t\t\t\tPromise.resolve().then(async () => await guardrail.check(inputText)),\n\t\t\t),\n\t\t);\n\t}\n\tconst results = await Promise.allSettled(guardrailPromises);\n\tconst passed: Array<PromiseFulfilledResult<GuardrailResult>> = [];\n\tconst failed: Array<PromiseRejectedResult | PromiseFulfilledResult<GuardrailResult>> = [];\n\tfor (const result of results) {\n\t\tconst checkFailed = failOnlyOnErrors\n\t\t\t? result.status === 'rejected' || !!result.value.executionFailed\n\t\t\t: result.status === 'rejected' || !!result.value.tripwireTriggered;\n\t\tif (result.status === 'fulfilled' && !checkFailed) {\n\t\t\tpassed.push(result);\n\t\t} else {\n\t\t\tfailed.push(result);\n\t\t}\n\t}\n\treturn { passed, failed };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAKO;AAUP,MAAM,uBAAuB,CAAC,eAAuB,YAAsC;AAC1F,SAAO,QAAQ,MAAM,CAAC,UAAU;AAC/B,UAAM,IAAI;AAAA,MACT;AAAA,MACA,OAAO,eAAe,OAAO,WAAW;AAAA,MACxC,OAAO;AAAA,IACR;AAAA,EACD,CAAC;AACF;AAEA,eAAsB,mBAAmB;AAAA,EACxC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACD,GAAgE;AAC/D,QAAM,oBAAqD,CAAC;AAC5D,aAAW,aAAa,gBAAgB,KAAK,GAAG;AAC/C,sBAAkB;AAAA,MACjB;AAAA,QACC,UAAU;AAAA;AAAA,QAEV,QAAQ,QAAQ,EAAE,KAAK,YAAY,MAAM,UAAU,MAAM,SAAS,CAAC;AAAA,MACpE;AAAA,IACD;AAAA,EACD;AACA,QAAM,UAAU,MAAM,QAAQ,WAAW,iBAAiB;AAC1D,QAAM,SAAyD,CAAC;AAChE,QAAM,SAAiF,CAAC;AACxF,aAAW,UAAU,SAAS;AAC7B,UAAM,cAAc,mBACjB,OAAO,WAAW,cAAc,CAAC,CAAC,OAAO,MAAM,kBAC/C,OAAO,WAAW,cAAc,CAAC,CAAC,OAAO,MAAM;AAClD,QAAI,OAAO,WAAW,eAAe,CAAC,aAAa;AAClD,aAAO,KAAK,MAAM;AAAA,IACnB,OAAO;AACN,aAAO,KAAK,MAAM;AAAA,IACnB;AAAA,EACD;AACA,SAAO,EAAE,QAAQ,OAAO;AACzB;","names":[]}