{"version":3,"sources":["../../../../nodes/Guardrails/actions/process.ts"],"sourcesContent":["import type { BaseChatModel } from '@langchain/core/language_models/chat_models';\nimport type { IExecuteFunctions } from 'n8n-workflow';\nimport { NodeOperationError } from 'n8n-workflow';\n\nimport { runStageGuardrails } from '../helpers/base';\nimport { splitByComma } from '../helpers/common';\nimport { mapGuardrailErrorsToMessage, mapGuardrailResultToUserResult } from '../helpers/mappers';\nimport { createLLMCheckFn } from '../helpers/model';\nimport { applyPreflightModifications } from '../helpers/preflight';\nimport { createJailbreakCheckFn, JAILBREAK_PROMPT } from './checks/jailbreak';\nimport { createKeywordsCheckFn } from './checks/keywords';\nimport { createNSFWCheckFn, NSFW_SYSTEM_PROMPT } from './checks/nsfw';\nimport { createCustomRegexCheckFn, createPiiCheckFn } from './checks/pii';\nimport { createSecretKeysCheckFn } from './checks/secretKeys';\nimport {\n\tcreateTopicalAlignmentCheckFn,\n\tTOPICAL_ALIGNMENT_SYSTEM_PROMPT,\n} from './checks/topicalAlignment';\nimport { createUrlsCheckFn } from './checks/urls';\nimport type {\n\tGroupedGuardrailResults,\n\tGuardrailsOptions,\n\tGuardrailUserResult,\n\tStageGuardRails,\n} from './types';\n\ninterface Result {\n\tchecks: GuardrailUserResult[];\n}\n\nexport async function process(\n\tthis: IExecuteFunctions,\n\titemIndex: number,\n\tmodel: BaseChatModel | null,\n): Promise<{\n\tguardrailsInput: string;\n\tpassed: Result | null;\n\tfailed: Result | null;\n}> {\n\tconst inputText = this.getNodeParameter('text', itemIndex) as string;\n\tconst operation = this.getNodeParameter('operation', 0) as 'classify' | 'sanitize';\n\tconst guardrails = this.getNodeParameter('guardrails', itemIndex) as GuardrailsOptions;\n\tconst customizeSystemMessage =\n\t\toperation === 'classify' &&\n\t\t(this.getNodeParameter('customizeSystemMessage', itemIndex, false) as boolean);\n\tconst systemMessage = customizeSystemMessage\n\t\t? (this.getNodeParameter('systemMessage', itemIndex) as string)\n\t\t: undefined;\n\tconst failedChecks: GuardrailUserResult[] = [];\n\tconst passedChecks: GuardrailUserResult[] = [];\n\n\tconst handleFailedResults = (results: GroupedGuardrailResults): GuardrailUserResult[] => {\n\t\tconst unexpectedError = results.failed.find(\n\t\t\t(result) =>\n\t\t\t\tresult.status === 'rejected' ||\n\t\t\t\t(result.status === 'fulfilled' && result.value.executionFailed),\n\t\t);\n\n\t\tif (results.failed.length && operation === 'sanitize') {\n\t\t\tthrow new NodeOperationError(this.getNode(), 'Failed to sanitize text', {\n\t\t\t\tdescription: mapGuardrailErrorsToMessage(results.failed),\n\t\t\t\titemIndex,\n\t\t\t});\n\t\t}\n\t\tif (unexpectedError && !this.continueOnFail()) {\n\t\t\tconst error =\n\t\t\t\tunexpectedError.status === 'rejected'\n\t\t\t\t\t? unexpectedError.reason\n\t\t\t\t\t: unexpectedError.value.originalException;\n\t\t\tthrow new NodeOperationError(this.getNode(), error, {\n\t\t\t\tdescription: error?.description || error?.message,\n\t\t\t\titemIndex,\n\t\t\t});\n\t\t}\n\t\treturn results.failed.map(mapGuardrailResultToUserResult);\n\t};\n\n\tconst stageGuardrails: StageGuardRails = {\n\t\tpreflight: [],\n\t\tinput: [],\n\t};\n\n\tif (guardrails.pii?.value) {\n\t\tconst { entities } = guardrails.pii.value;\n\t\tstageGuardrails.preflight.push({\n\t\t\tname: 'personalData',\n\t\t\tcheck: createPiiCheckFn({\n\t\t\t\tentities,\n\t\t\t}),\n\t\t});\n\t}\n\n\tif (guardrails.customRegex?.regex) {\n\t\tstageGuardrails.preflight.push({\n\t\t\tname: 'customRegex',\n\t\t\tcheck: createCustomRegexCheckFn({\n\t\t\t\tcustomRegex: guardrails.customRegex.regex,\n\t\t\t}),\n\t\t});\n\t}\n\n\tif (guardrails.secretKeys?.value) {\n\t\tconst { permissiveness } = guardrails.secretKeys.value;\n\t\tstageGuardrails.preflight.push({\n\t\t\tname: 'secretKeys',\n\t\t\tcheck: createSecretKeysCheckFn({ threshold: permissiveness }),\n\t\t});\n\t}\n\n\tif (guardrails.urls?.value) {\n\t\tconst { allowedUrls, allowedSchemes, blockUserinfo, allowSubdomains } = guardrails.urls.value;\n\t\tstageGuardrails.preflight.push({\n\t\t\tname: 'urls',\n\t\t\tcheck: createUrlsCheckFn({\n\t\t\t\tallowedUrls: splitByComma(allowedUrls),\n\t\t\t\tallowedSchemes,\n\t\t\t\tblockUserinfo,\n\t\t\t\tallowSubdomains,\n\t\t\t}),\n\t\t});\n\t}\n\n\tif (operation === 'classify') {\n\t\tif (!model) {\n\t\t\tthrow new NodeOperationError(this.getNode(), 'Chat Model is required for classify operation');\n\t\t}\n\n\t\tif (guardrails.keywords) {\n\t\t\tstageGuardrails.input.push({\n\t\t\t\tname: 'keywords',\n\t\t\t\tcheck: createKeywordsCheckFn({ keywords: splitByComma(guardrails.keywords) }),\n\t\t\t});\n\t\t}\n\n\t\tif (guardrails.jailbreak?.value) {\n\t\t\tconst { prompt, threshold } = guardrails.jailbreak.value;\n\t\t\tstageGuardrails.input.push({\n\t\t\t\tname: 'jailbreak',\n\t\t\t\tcheck: createJailbreakCheckFn({\n\t\t\t\t\tmodel,\n\t\t\t\t\tprompt: prompt?.trim() || JAILBREAK_PROMPT,\n\t\t\t\t\tthreshold,\n\t\t\t\t\tsystemMessage,\n\t\t\t\t}),\n\t\t\t});\n\t\t}\n\n\t\tif (guardrails.nsfw?.value) {\n\t\t\tconst { prompt, threshold } = guardrails.nsfw.value;\n\t\t\tstageGuardrails.input.push({\n\t\t\t\tname: 'nsfw',\n\t\t\t\tcheck: createNSFWCheckFn({\n\t\t\t\t\tmodel,\n\t\t\t\t\tprompt: prompt?.trim() || NSFW_SYSTEM_PROMPT,\n\t\t\t\t\tthreshold,\n\t\t\t\t\tsystemMessage,\n\t\t\t\t}),\n\t\t\t});\n\t\t}\n\n\t\tif (guardrails.topicalAlignment?.value) {\n\t\t\tconst { prompt, threshold } = guardrails.topicalAlignment.value;\n\t\t\tstageGuardrails.input.push({\n\t\t\t\tname: 'topicalAlignment',\n\t\t\t\tcheck: createTopicalAlignmentCheckFn({\n\t\t\t\t\tmodel,\n\t\t\t\t\tprompt: prompt?.trim() || TOPICAL_ALIGNMENT_SYSTEM_PROMPT,\n\t\t\t\t\tsystemMessage,\n\t\t\t\t\tthreshold,\n\t\t\t\t}),\n\t\t\t});\n\t\t}\n\n\t\tif (guardrails.custom?.guardrail) {\n\t\t\tfor (const customGuardrail of guardrails.custom.guardrail) {\n\t\t\t\tconst { prompt, threshold, name } = customGuardrail;\n\t\t\t\tstageGuardrails.input.push({\n\t\t\t\t\tname,\n\t\t\t\t\tcheck: createLLMCheckFn(name, {\n\t\t\t\t\t\tmodel,\n\t\t\t\t\t\tprompt,\n\t\t\t\t\t\tthreshold,\n\t\t\t\t\t\tsystemMessage,\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tconst preflightResults = await runStageGuardrails({\n\t\tinputText,\n\t\tstageGuardrails,\n\t\tstage: 'preflight',\n\t\tfailOnlyOnErrors: operation === 'sanitize',\n\t});\n\n\tif (preflightResults.failed.length > 0) {\n\t\tfailedChecks.push.apply(failedChecks, handleFailedResults(preflightResults));\n\t\treturn {\n\t\t\tguardrailsInput: inputText,\n\t\t\tpassed: null,\n\t\t\tfailed: {\n\t\t\t\tchecks: failedChecks,\n\t\t\t},\n\t\t};\n\t} else {\n\t\tpassedChecks.push.apply(\n\t\t\tpassedChecks,\n\t\t\tpreflightResults.passed.map(mapGuardrailResultToUserResult),\n\t\t);\n\t}\n\n\tconst modifiedInputText = applyPreflightModifications(\n\t\tinputText,\n\t\tpreflightResults.passed.map((result) => result.value),\n\t);\n\n\tconst inputResults = await runStageGuardrails({\n\t\tinputText: modifiedInputText,\n\t\tstageGuardrails,\n\t\tstage: 'input',\n\t\tfailOnlyOnErrors: operation === 'sanitize',\n\t});\n\tif (inputResults.failed.length > 0) {\n\t\tfailedChecks.push.apply(failedChecks, handleFailedResults(inputResults));\n\t\treturn {\n\t\t\tguardrailsInput: modifiedInputText,\n\t\t\tpassed: null,\n\t\t\tfailed: {\n\t\t\t\tchecks: failedChecks,\n\t\t\t},\n\t\t};\n\t} else {\n\t\tpassedChecks.push.apply(passedChecks, inputResults.passed.map(mapGuardrailResultToUserResult));\n\t}\n\n\treturn {\n\t\tguardrailsInput: modifiedInputText,\n\t\tpassed: {\n\t\t\tchecks: passedChecks,\n\t\t},\n\t\tfailed: null,\n\t};\n}\n"],"mappings":"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","names":[]}